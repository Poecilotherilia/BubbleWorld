---
--- Generated by bbhuang
--- File name : black_store_controller.lua.txt
--- DateTime : 2023/02/07
--- Description :黑市商人管理器
---
local role_res_util = require 'game/utils/role_res_util'
local wwise_util = require 'game/utils/wwise_util/wwise_util'
local data = data
local tables = tables
local res = res
local log = log
local cs = cs
local GameObject = cs.GameObject
local LuaUtil = cs.LuaUtil
local enum_common = enum.common
local camera_layer = enum_common.camera_layer
local camera_blend_type = enum_common.camera_blend_type
local asset_type = df.enum.asset_type
local CinemachineVirtualCamera = cs.CinemachineVirtualCamera

local CharacterLuaBehaviour = cs.CharacterLuaBehaviour
local GameUnitLuaBehaviour = cs.GameUnitLuaBehaviour
local tag = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_BLACKMARKET_PARENT_TAG, tables.ConstClient.properties.String)
local model_id = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_BLACKMARKET_CHARACTER_MODEL, tables.ConstClient.properties.String)
local role_born_point_id = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_BLACKMARKET_CHARACTER_POINT, tables.ConstClient.properties.String)
local role_born_point = data.get(tables.Point.name, role_born_point_id)

local model_enter_action = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_BLACKMARKET_CHARACTER_ACTION_START, tables.ConstClient.properties.String)
local model_exit_action = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_BLACKMARKET_CHARACTER_ACTION_END, tables.ConstClient.properties.String)
local model_idle_action = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_BLACKMARKET_CHARACTER_ACTION_IDLE, tables.ConstClient.properties.String)


---@type Action
local model_enter_action_data 
local model_exit_action_data 
local model_idle_action_data 


local audio_1 = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_BLACKMARKET_AUDIO_RANDOM_1, tables.ConstClient.properties.String)
--local audio_2 = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_BLACKMARKET_AUDIO_RANDOM_2, tables.ConstClient.properties.String)
--local audio_3 = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_BLACKMARKET_AUDIO_RANDOM_3, tables.ConstClient.properties.String)
--local math_random  = math.random

local camera_path = "Assets/Art/Character/Common/skill_camera_node.prefab";
---@type Action
local zhan_shi_anim_data = data.get(tables.Action.name, "N_Mistique_ZhanshiCamera")
local zhan_shi_finish_anim_data = data.get(tables.Action.name, "N_Mistique_FinishCamera")
---@class black_store_controller
local black_store_controller = class("black_store_controller")

---构造函数
---@protected
function black_store_controller:ctor()
    model_enter_action_data = data.get(tables.Action.name, model_enter_action)
    model_exit_action_data = data.get(tables.Action.name, model_exit_action)
    model_idle_action_data = data.get(tables.Action.name, model_idle_action)
    
    self.parent_node_transform = nil
    self.res_loader = nil
    self.pool = nil
    
    self.model_obj = nil
    self.character_lua_behaviour = nil
    
    self:init()
end

---销毁
---@public
function black_store_controller:dispose()
    self.character_lua_behaviour = nil
    self.model_obj = nil
    
    self:remove_virtual_camera()
    
    res.unload_instance(self.model_obj, self.res_loader, nil)
    
    self.parent_node_transform = nil
    self.pool:Clear()
    self.pool = nil
    self.res_loader:Dispose()
    self.res_loader = nil
end

---初始化
---@private
function black_store_controller:init()
    self.parent_node_transform = GameObject.FindWithTag(tag).transform
    self.res_loader = res.create_res_loader()
    self.pool = res.create_res_pool(self.res_loader, self.parent_node_transform)
end

---初始模型
---@public
function black_store_controller:init_model()
    local model = role_res_util.load_role_res_sync(model_id, "black_store_model", self.parent_node_transform, nil, self.res_loader, self.pool)
    self.model_obj = model
    self.character_lua_behaviour = model:GetComponent(typeof(CharacterLuaBehaviour))
    self.character_lua_behaviour:InitLua(self)
    
    model.transform:SetLocalPosition(role_born_point.PositionX / 10000, (role_born_point.PositionY / 10000), role_born_point.PositionZ / 10000)
    model.transform:SetLocalRotation(role_born_point.RotationX / 10000, role_born_point.RotationY / 10000, role_born_point.RotationZ / 10000)
    model.transform:SetLocalScale(role_born_point.ScaleX / 10000, role_born_point.ScaleY / 10000, role_born_point.ScaleZ / 10000)
    
    self:play_idle_anim()
end

---播放进入黑市表现
---@public
function black_store_controller:play_enter_anim(callback)
    self.character_lua_behaviour:PlayAnimationAsync(model_enter_action_data.Name, 1, function()
        if callback then
            callback()
        end
        --self:play_idle_anim()
    end, self.res_loader, self.res_pool)
    
    wwise_util.play_audio(audio_1)
    
    self:init_virtual_camera()
end

---播放退出表现
---@public
function black_store_controller:play_exit_anim(callback)
    self.character_lua_behaviour:PlayAnimationAsync(model_exit_action_data.Name, 1, function()
        if callback then
            callback()
        end
        self:play_idle_anim()
    end, self.res_loader, self.res_pool)

    self.camera_behaviour:PlayAnimationAsync(zhan_shi_finish_anim_data.Name, 1, function(...)

    end , self.res_loader, nil)
end

---播放idle 动画
---@private
function black_store_controller:play_idle_anim()
    self.character_lua_behaviour:PlayAnimationAsync(model_idle_action_data.Name, 1, nil, self.res_loader, self.res_pool)
end

---初始化镜头
---@private
function black_store_controller:init_virtual_camera()
    res.load_instance_async(camera_path,
            string.get_file_name_without_extension(camera_path),
            self.model_obj.transform,
            nil,
            self.res_loader,
            nil,
            function(obj)
                self:on_load_v_camera_callback(obj)
            end
    )
end

---镜头加载完毕
---@private
function black_store_controller:on_load_v_camera_callback(obj)
    local point_id = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_BLACKMARKET_CAMERA_POINT, tables.ConstClient.properties.String)
    ---@type Point
    local point = data.get(tables.Point.name, point_id)

    ---@type UnityEngine.GameObject
    local v_camera = obj:FindChildObject("Camera_node/v_camera"):GetOrAddComponent(typeof(CinemachineVirtualCamera))
    local camera_id = camera_manager.add_virtual_camera(v_camera, enum.common.camera_layer.UI)
    self.camera_behaviour = obj:GetOrAddComponent(typeof(GameUnitLuaBehaviour))
    
    camera_manager.show_virtual_camera(camera_id, camera_blend_type.Cut)
    self.view_camera_id = camera_id
    local anim_path = zhan_shi_anim_data.Name
    self.camera_behaviour:PlayAnimationAsync(anim_path, 1, function(...)
       
    end , self.res_loader, nil)
end

---移除相机
---@public
function black_store_controller:remove_virtual_camera()
    if self.view_camera_id then
        camera_manager.remove_virtual_camera(self.view_camera_id)
        res.unload_instance(self.camera_behaviour.gameObject, self.res_loader)
    end
    self.view_camera_id = nil
    self.camera_behaviour = nil
end

return black_store_controller