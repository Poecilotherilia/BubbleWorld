---
--- Generated by libin
--- File name : explore_node_render_unit.lua.txt
--- DataTime : 2022/07/06
--- Description : 探索节点渲染器-普通战斗
---

local DOTweenAnimation = cs.DOTweenAnimation
local explore_node_extend_type = enum.experience.explore_node_extend_type
local message = message
---@type message_type
local message_type = enum.message_type
local game_util = require "game/utils/game_util"
local Color = cs.Color

local super = require "framework/binding/bindable_item"

---@class explore_node_render_unit : bindable_item
local explore_node_render_unit = class("explore_node_render_unit", super)

--region base api

---构造方法
---@protected
---@param cs_node_unit Game.Explore.ExploreNodeUnit
---@param node_data explore_node_data
function explore_node_render_unit:ctor(cs_node_unit, node_data)
    ---@type Game.Explore.ExploreNodeUnit
    self.cs_unit = cs_node_unit
    ---@type explore_node_data
    self.node_data = node_data
    ---@type UnityEngine.Transform
    self.trans = self.cs_unit.transform
    ---@type UnityEngine.GameObject
    self.obj = self.cs_unit.gameObject
    --self.obj:SetLocalScale(1.2, 1.2, 1.2)

    ---稀有怪扩展数据
    if self.node_data.is_extend and self.node_data.extend_type == explore_node_extend_type.RARE then
        self.normal_color = Color(243, 225, 191)
        self.red_color = Color(255, 0, 0)
    end
    
    ---@type UnityEngine.GameObject
    self.tween_root = nil
    ---@type DG.Tweening.DOTweenAnimation
    self.active_tween = nil

    ---@type string
    self.node_icon = nil
    ---@type boolean
    self.is_rare = nil
    ---@type string
    self.rare_icon = nil
    ---@type string
    self.rare_time = nil
    ---@type UnityEngine.Color
    self.rare_time_color = nil
    ---@type boolean
    self.is_red = false

    super.ctor(self, node_data)
    self.cs_unit:SetContext(self)
    
    self:add_event()
end

---@public
function explore_node_render_unit:dispose()
    self:del_event()
    super.dispose(self)
    self.cs_unit = nil
    self.node_data = nil
    self.obj = nil
    self.trans = nil
    self.active_tween = nil
    self.tween_root = nil
    self.node_icon = nil
    self.is_rare = nil
    self.rare_icon = nil
    self.rare_time = nil
    self.rare_time_color = nil
end

---初始化绑定器
---@protected override
function explore_node_render_unit:init_binding()
    self:create_simple_property("node_icon", nil, true)
    self:create_simple_property("is_new", nil, true)

    ---稀有怪扩展数据
    if self.node_data.is_extend and self.node_data.extend_type == explore_node_extend_type.RARE then
        self:create_simple_property("is_rare", false, true)
        self:create_simple_property("rare_icon", nil, true)
        self:create_simple_property("rare_time", "", true)
        self:create_simple_property("rare_time_color", nil, true)
    end
end

---获得CS传入的游戏对象上挂载的脚本
---@protected override
function explore_node_render_unit:init_component()
    ---@type UnityEngine.GameObject
    self.tween_root = self:get_object("active_tween")
    if nil ~= self.tween_root then
        self.active_tween = self.tween_root:GetComponent(typeof(DOTweenAnimation))
    end
end

--endregion

--region event

---@private
function explore_node_render_unit:add_event()
    ---稀有怪扩展数据
    if self.node_data.is_extend and self.node_data.extend_type == explore_node_extend_type.RARE then
        message.add_listener(message_type.EXPLORE_RARE_COOL_DOWN_EACH, self.on_cool_down_each, self)
    end
end

---@private
function explore_node_render_unit:del_event()
    ---稀有怪扩展数据
    if self.node_data.is_extend and self.node_data.extend_type == explore_node_extend_type.RARE then
        message.remove_listener(message_type.EXPLORE_RARE_COOL_DOWN_EACH, self.on_cool_down_each, self)
    end
end

---倒计时
---@private
---@param node_id string
---@param time number
function explore_node_render_unit:on_cool_down_each(node_id, time)
    if nil == self.node_data then
        return
    end
    
    if self.node_data.node.Id == node_id then
        if time > 0 then
            local str_time = game_util.get_date_time_minute_and_second(time)
            self.rare_time = str_time
        else
            self.rare_time = "00:00"
        end
        if time < 60 then
            if not self.is_red then
                self.is_red = true
                self.rare_time_color = self.red_color
            end
        else
            if self.is_red then
                self.is_red = false
                self.rare_time_color = self.normal_color
            end
        end
    end
end

--endregion

--region logic

---显示列表元素
---@protected override
function explore_node_render_unit:show_item()
    --图片
    self.node_icon = self.node_data.node.NodeIcon

    if self.node_data.is_extend and self.node_data.extend_type == explore_node_extend_type.RARE then
        --稀有怪处理
        self.is_rare = true
        ---@type ExploreElite
        local rare_data = self.node_data.extend_data
        self.rare_icon = rare_data.EliteDogtag
    end
    
    --主线最新路点判断
    self:update_arrived_stata()
end

---刷新Item
---@public override
function explore_node_render_unit:update_item()
    
end

---获得世界坐标
---@public
---@return number, number, number
function explore_node_render_unit:get_position()
    return self.obj:GetPosition()
end

---设置节点显/隐
---@public override
---@param is_active boolean
function explore_node_render_unit:set_active(is_active)
    if self.node_data.is_extend and self.node_data.extend_type == explore_node_extend_type.RARE then
        --稀有怪处理
        self.cs_unit:SetActive(true)
    else
        self.cs_unit:SetActive(is_active)
    end
    
    local flag = game_data_manager.explore:get_explore_node_anim_flag_by_id(self.node_data.node.Id)
    if flag == 1 then
        if nil ~= self.tween_root then
            self.tween_root:SetLocalScale(1,1,1)
        end
    else
        if nil ~= self.tween_root then
            self.tween_root:SetLocalScale(0,0,0)
        end
    end
end

---@public
---@return UnityEngine.Transform
function explore_node_render_unit:get_transform()
    return self.trans
end

---@public
---@return UnityEngine.GameObject
function explore_node_render_unit:get_obj()
    return self.obj
end


---@public
function explore_node_render_unit:play_active_effect()
    if nil ~= self.active_tween then
        self.active_tween:DOPlay()
    end
    
    --播放激活特效
    effect.play_effect_async("Effect_Scene_Explore_Node_Appear", self.obj, 1)
end

---获得路点类型
---@public
---@return explore_node_event_type
function explore_node_render_unit:get_node_type()
    return self.node_data.node.EventType
end

---刷新到达状态
---@public
function explore_node_render_unit:update_arrived_stata()
    local is_main_node = self.node_data:is_main_node()
    if is_main_node then
        if self.node_data.state >= 1 then
            local flag = self.node_data.is_arrived
            if flag == 0 then
                self.is_new = true
            else
                self.is_new = false
            end
        else
            self.is_new = false
        end
    else
        self.is_new = false
    end
end

--endregion

return explore_node_render_unit