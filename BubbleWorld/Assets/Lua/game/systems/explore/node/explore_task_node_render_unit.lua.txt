---
--- Generated by libin
--- File name : explore_task_node_render_unit.lua.txt
--- DataTime : 2023/05/25
--- Description : 
---

local data = data
local tables = tables

local super = require "game/systems/explore/node/explore_node_render_unit"

---@class explore_task_node_render_unit : explore_node_render_unit
local explore_task_node_render_unit = class("explore_task_node_render_unit", super)

--region base api

---构造方法
---@protected
---@param cs_node_unit Game.Explore.ExploreNodeUnit
---@param node_data explore_node_data
function explore_task_node_render_unit:ctor(cs_node_unit, node_data)
    ---@type ExploreTask
    self.task_data = data.get(tables.ExploreTask.name, node_data.node.EventParam)
    super.ctor(self, cs_node_unit, node_data)
    self.effect_id = nil
end

---@public
function explore_task_node_render_unit:dispose()
    super.dispose(self)
    if nil ~= self.effect_id then
        effect.manual_unload_effect(self.effect_id)
        self.effect_id = nil
    end
end

---初始化绑定器
---@protected override
function explore_task_node_render_unit:init_binding()
    super.init_binding(self)
    self:create_simple_property("is_lock_1", false, true)
    self:create_simple_property("is_lock_2", false, true)
    self:create_simple_property("star_progress", 0, true)
    self:create_simple_property("cur_star_count", "", true)
    self:create_simple_property("target_star_count", "", true)
    self:create_simple_property("task_progress", 0, true)
    self:create_simple_property("cur_task_count", "", true)
    self:create_simple_property("target_task_count", "", true)
    self:create_simple_property("is_done", false, true)
end

--endregion

--region logic

---显示列表元素
---@protected override
function explore_task_node_render_unit:show_item()
    super.show_item(self)

    if self.node_data.state <= 0 then
        --星级判定
        local chapter_id = system_manager.explore.cur_chapter_id
        local cur_star_count = game_data_manager.explore:get_explore_chapter_star_count(chapter_id)
        local target_star_count = self:get_target_star_count()
        self.is_lock_2 = true
        self.is_done = false
        local progress = cur_star_count / target_star_count
        ---@type number
        self.star_progress = progress
        ---@tpye number
        self.cur_star_count = cur_star_count
        ---@type number
        self.target_star_count = target_star_count
    else
        self.is_lock_2 = false
        local task_id = self.task_data.MissionID
        ---@type ExploreMission
        local mission = data.get(tables.ExploreMission.name, task_id)
        ---@type string[]
        local arr = mission.ObjectValue
        local target = tonumber(arr[1])
        local cur = game_data_manager.explore_task:get_explore_task_progress(task_id)
        ---@type number
        self.task_progress = cur / target
        if self.task_progress >= 1 then
            self.is_done = true
        else
            self.is_done = false
        end
        
        ---@type number
        self.cur_task_count = cur
        ---@type number
        self.target_task_count = target
    end
end

---设置节点显/隐
---@protected override
---@param is_active boolean
function explore_task_node_render_unit:set_active(is_active)
    --self.cs_unit:SetActive(is_active)
    self.is_lock_1 = false
end

---@private
---@return number
function explore_task_node_render_unit:get_target_star_count()
    ---@type Condition
    local condition = data.get(tables.Condition.name, self.node_data.node.ExtraUnlockCondition)
    local target_count = condition.Data[1].Array[3]
    
    return tonumber(target_count)
end

---刷新到达状态
---@public
function explore_task_node_render_unit:update_arrived_stata()

end

---@public
function explore_task_node_render_unit:play_active_effect()
    if not string.is_nil_or_empty(self.node_data.node.Effect) then
        self.effect_id = effect.play_effect_async(self.node_data.node.Effect, self.obj, 1)
    end
end

--endregion


return explore_task_node_render_unit
