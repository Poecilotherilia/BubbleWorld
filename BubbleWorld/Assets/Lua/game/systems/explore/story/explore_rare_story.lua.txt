---
--- Generated by libin
--- File name : explore_rare_story.lua.txt
--- DataTime : 2023/10/18
--- Description : 
---

local message = message
---@type message_type
local message_type = enum.message_type
local data = data
local tables = tables
local explore_node_event_type = enum.experience.explore_node_event_type
local explore_node_extend_type = enum.experience.explore_node_extend_type
local array_table = array_table

local super = require "game/systems/explore/story/explore_base_story"

---@class explore_rare_story : explore_base_story
local explore_rare_story = class("explore_rare_story", super)

--region base api

function explore_rare_story:ctor(ctrl)
    super.ctor(self, ctrl)
end

function explore_rare_story:dispose()
    super.dispose(self)
end

--endregion

--region logic

---检查播放路点开始剧情
---@public
---@param node_id string
---@param call_back function
function explore_rare_story:check_node_start_story(node_id, call_back)
    ---@type explore_node_data
    local node_data = game_data_manager.explore:get_explore_node_data_by_id(node_id)
    --TODO:屏蔽稀有怪
    if node_data.is_extend and node_data.extend_type == explore_node_extend_type.RARE then
        ---@type ExploreElite
        local rare_data = node_data.extend_data
        ---@type array2_string[]
        local arr2_str = rare_data.Story
        if nil ~= arr2_str[1] then
            local flag = game_data_manager.explore_rare:check_is_play_story(node_id, 0)
            if not flag then
                ---@type string[]
                local story_arr = {}
                local story_id = arr2_str[1].Array[1]
                array_table.insert(story_arr, story_id)
                --播放剧情时禁止一切操作
                message.broadcast(message_type.EXPLORE_IS_CAN_FINGER, false)
                system_manager.explore:set_can_drag_camera(false)
                system_manager.story:start_explorer_story(story_arr, nil, false, function()
                    --设置剧情完成
                    local done_flag = game_data_manager.explore_rare:set_story_flag(node_id, 0)
                    system_manager.explore.network:req_set_explore_elite_flag(rare_data.Id, done_flag)
                    --播放剧情完成恢复操作
                    message.broadcast(message_type.EXPLORE_IS_CAN_FINGER, true)
                    system_manager.explore:set_can_drag_camera(true)
                    if nil ~= call_back then
                        call_back()
                    end
                end)
            else
                if nil ~= call_back then
                    call_back()
                end
            end
        else
            if nil ~= call_back then
                call_back()
            end
        end
    end
end

---是否能播放后端剧情
---@public
---@param call_back function
function explore_rare_story:check_node_end_story(call_back)

end

--endregion


return explore_rare_story
