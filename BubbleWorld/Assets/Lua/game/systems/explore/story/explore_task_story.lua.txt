---
--- Generated by libin
--- File name : explore_task_story.lua.txt
--- DataTime : 2023/07/04
--- Description : 
---

local message = message
---@type message_type
local message_type = enum.message_type
local data = data
local tables = tables
local explore_node_event_type = enum.experience.explore_node_event_type

local super = require "game/systems/explore/story/explore_base_story"

---@class explore_task_story : explore_base_story
local explore_task_story = class("explore_task_story", super)

--region base api

function explore_task_story:ctor(ctrl)
    super.ctor(self, ctrl)
end

function explore_task_story:dispose()
    super.dispose(self)
end

--endregion

--region logic

---检查播放路点开始剧情
---@public
---@param node_id string
---@param call_back function
function explore_task_story:check_node_start_story(node_id, call_back)
    ---@type explore_node_data
    local node_data = game_data_manager.explore:get_explore_node_data_by_id(node_id)
    if node_data.node.EventType == explore_node_event_type.TASK then
        if node_data.is_arrived == 1 then
            ---@type ExploreTask
            local task_data = data.get(tables.ExploreTask.name, node_data.node.EventParam)
            local task_state = game_data_manager.explore_task:get_explore_task_status(task_data.MissionID)
            if task_state == 2 then
                local str_arr = task_data.TaskNodeStory4
                if nil ~= str_arr and #str_arr > 0 then
                    --已领取 播放剧情4
                    message.broadcast(message_type.EXPLORE_IS_CAN_FINGER, false)
                    system_manager.explore:set_can_drag_camera(false)
                    system_manager.story:start_explorer_story(str_arr, nil, false, function()
                        --设置剧情完成
                        system_manager.explore.network:sync_explore_node_story_progress(task_data.TaskNodeStory4)
                        --播放剧情完成恢复操作
                        message.broadcast(message_type.EXPLORE_IS_CAN_FINGER, true)
                        system_manager.explore:set_can_drag_camera(true)
                        if nil ~= call_back then
                            call_back()
                        end
                    end)
                else
                    if nil ~= call_back then
                        call_back()
                    end
                end
            elseif task_state == 1 then
                local str_arr = task_data.TaskNodeStory3
                if nil ~= str_arr and #str_arr > 0 then
                    --已完成可领取 播放剧情3
                    message.broadcast(message_type.EXPLORE_IS_CAN_FINGER, false)
                    system_manager.explore:set_can_drag_camera(false)
                    system_manager.story:start_explorer_story(str_arr, nil, false, function()
                        --设置剧情完成
                        system_manager.explore.network:sync_explore_node_story_progress(task_data.TaskNodeStory3)
                        --播放剧情完成恢复操作
                        message.broadcast(message_type.EXPLORE_IS_CAN_FINGER, true)
                        system_manager.explore:set_can_drag_camera(true)
                        if nil ~= call_back then
                            call_back()
                        end
                    end)
                else
                    if nil ~= call_back then
                        call_back()
                    end
                end
            else
                local str_arr = task_data.TaskNodeStory2
                if nil ~= str_arr and #str_arr > 0 then
                    --未完成 播放剧情2
                    message.broadcast(message_type.EXPLORE_IS_CAN_FINGER, false)
                    system_manager.explore:set_can_drag_camera(false)
                    system_manager.story:start_explorer_story(str_arr, nil, false, function()
                        --设置剧情完成
                        system_manager.explore.network:sync_explore_node_story_progress(task_data.TaskNodeStory2)
                        --播放剧情完成恢复操作
                        message.broadcast(message_type.EXPLORE_IS_CAN_FINGER, true)
                        system_manager.explore:set_can_drag_camera(true)
                        if nil ~= call_back then
                            call_back()
                        end
                    end)
                else
                    if nil ~= call_back then
                        call_back()
                    end
                end
            end

        end
    end
end


---是否能播放后端剧情
---@public
---@param call_back function
function explore_task_story:check_node_end_story(call_back)
    
end

--endregion

return explore_task_story
