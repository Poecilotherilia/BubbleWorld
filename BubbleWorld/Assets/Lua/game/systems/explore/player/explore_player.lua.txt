---
--- Generated by libin
--- File name : explore_player.lua.txt
--- DataTime : 2022/07/13
--- Description : 探索玩家控制器
---

local ExplorePlayer = cs.ExplorePlayer
local GameObject = cs.GameObject
local tables = tables
local data = data
local res = res
local GameUnitLuaBehaviour = cs.GameUnitLuaBehaviour
local string = string
local BoxCollider = cs.BoxCollider
local LuaUtil = cs.LuaUtil

---@class explore_player
local explore_player = class("explore_player")

--region base api

---构造方法
---@protected
function explore_player:ctor()
    ---@type UnityEngine.GameObject
    self.obj = nil
    ---@type Game.Explore.ExplorePlayer
    self.cs_player = nil

    ---@type UnityEngine.BoxCollider
    self.box_collier = nil
    ---@type UnityEngine.GameObject
    self.hero_obj = nil
    ---@type Game.Behaviour.GameUnitLuaBehaviour
    self.hero_behaviour = nil
    ---@type UnityEngine.GameObject
    self.hero_shadow_obj = nil
    ---@type Game.Behaviour.GameUnitLuaBehaviour
    self.hero_shadow_behaviour = nil
    ---@type DeusFramework.Res.DfResLoader
    self.res_loader = nil

    self.stand_action_id = nil
    self.run_action_id = nil
 
    self.callback = nil
end

---销毁
---@public
function explore_player:dispose()
    if not LuaUtil.IsNull(self.box_collier) then
        self.box_collier = nil
    end
    self.callback = nil
    self.cs_player = nil
    self.hero_behaviour = nil
    res.unload_instance(self.hero_shadow_obj, self.res_loader)
    res.unload_instance(self.hero_obj, self.res_loader)
    self.hero_obj = nil
    self.hero_shadow_behaviour = nil
    self.hero_shadow_obj = nil
    self.res_loader = nil
    self.stand_action_id = nil
    self.run_action_id = nil
    GameObject.Destroy(self.obj)
    self.obj = nil

end

---初始化玩家控制器
---@public
---@param obj UnityEngine.GameObject
function explore_player:init(obj)
    self.obj = obj
    self.cs_player = self.obj:GetComponent(typeof(ExplorePlayer))
    self.cs_player:InitLua(self)
    self.res_loader = system_manager.explore.res_loader

    self.callback = nil
    
    --TODO: 默认设置一条跟随线
    ---@return Dreamteck.Splines.SplineComputer
    local follow_computer = system_manager.explore:get_default_follow()
    if nil ~= follow_computer then
        self.cs_player:SetDefaultFollow(follow_computer)
    end
    
    --加载主角模型
    self:load_hero_sync()
end

--endregion

--region hero

---加载主角
---@private
function explore_player:load_hero_sync()
    local hero_res_id = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_HERO_RES_ID, tables.ConstClient.properties.String)
    ---@type RoleRes
    local role_res = data.get(tables.RoleRes.name, hero_res_id)
    self.stand_action_id = role_res.ArderIdleAction
    self.run_action_id = role_res.ArderRunAction
    
    local model_root = self.cs_player.ModelRoot
    
    self.hero_obj = res.load_instance_sync(role_res.ModelPath, "Hero", model_root, nil, self.res_loader, nil)
    self.hero_obj:SetLocalScale(1.5, 1.5, 1.5)
    self.hero_behaviour = self.hero_obj:GetComponent(typeof(GameUnitLuaBehaviour))
    self.box_collier = self.hero_obj:GetComponent(typeof(BoxCollider))
    if not LuaUtil.IsNull(self.box_collier) then
        self.box_collier.enabled = false
    end
    self.cs_player:InitRender()
    
    local hero_shadow_asset_path = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_EXPLORE_HERO_SHADOW, tables.ConstClient.properties.String)
    if not string.is_nil_or_empty(hero_shadow_asset_path) then
        self.hero_shadow_obj = res.load_instance_sync(hero_shadow_asset_path, "Hero_Shadow",  self.obj.transform, nil, self.res_loader, nil)
        self.hero_shadow_obj:SetLocalPosition(0, 0.1, 0)
        --self.hero_shadow_behaviour = self.hero_shadow_obj:GetComponent(typeof(GameUnitLuaBehaviour))
    end
    
    self:play_hero_idle_anim()
end

---主角播放跟随动画
---@public
function explore_player:play_hero_follow_anim()
    local act = data.get(tables.Action.name, self.run_action_id, tables.Action.properties.Name)
    if nil ~= self.hero_behaviour then
        self.hero_behaviour:PlayAnimationAsync(act, 1, nil, self.res_loader, nil, 0.2)
    end
    --if nil ~= self.hero_shadow_behaviour then
    --    self.hero_shadow_behaviour:PlayAnimationAsync(act, 1, nil, self.res_loader, nil, 0.2)
    --end
    
end

---主角播放idle
---@private
function explore_player:play_hero_idle_anim()
    --播放idle
    local act = data.get(tables.Action.name, self.stand_action_id, tables.Action.properties.Name)

    if nil ~= self.hero_behaviour then
        self.hero_behaviour:PlayAnimationAsync(act, 1, nil, self.res_loader, nil, 0.2)
    end

    --if nil ~= self.hero_shadow_behaviour then
    --    self.hero_shadow_behaviour:PlayAnimationAsync(act, 1, nil, self.res_loader, nil, 0.2)
    --end
end


--endregion

--region logic

---跟随连线
---@public
---@param computer Dreamteck.Splines.SplineComputer
---@param from number
---@param to number 
---@param time number
---@param direction number
function explore_player:player_follow_line(computer, from, to, time, direction)
    if nil ~= self.cs_player then
        self.cs_player:SplineFollow(computer, from, to, time, direction)
    end
end

---设置玩家显隐
---@public
---@param is_active boolean
function explore_player:set_active(is_active)
    if nil ~= self.cs_player then
        self.cs_player:SetActive(is_active)
    end
end

---跟随完毕
---@public
function explore_player:follow_done()
    self:play_hero_idle_anim()
    if nil ~= self.cs_player then
        self.cs_player:ResetSplineFollow()
    end
end


--endregion

--region change layer

---当玩家切换场景分层
---@public
---@param node_data explore_node_data
function explore_player:change_layer(node_data)
    local node_id = node_data.node.Id
    local layer_index = node_data.node.LayerIndex
    ---@type explore_line_data[]
    local line_data_arr = game_data_manager.explore:get_explore_line_data_by_node_id(node_id)
    ---@type explore_line_data
    local target_line_data = nil
    for i = 1, #line_data_arr do
        ---@type explore_line_data
        local line_data = line_data_arr[i]
        if line_data.layer_index == layer_index then
            target_line_data = line_data
            break
        end
    end

    if nil == target_line_data then
        return
    end
    
    local line_name = target_line_data:get_line_name()
    ---@type explore_line_render_unit
    local line_render_unit = system_manager.explore:get_line_render_unit(line_name)
    if nil == line_render_unit then
        return
    end
    
    local node_name = node_data:get_node_name()
    ---@type explore_node_render_unit
    local node_render_unit = system_manager.explore:get_node_render_unit(node_name)
    if nil == node_render_unit then
        return
    end
    
    --设置角色位移
    local x,y,z = node_render_unit:get_position()
    self.obj:SetPosition(x, y, z)

    --设置角色跟随
    ---@return Dreamteck.Splines.SplineComputer
    local follow_computer = line_render_unit:get_spline_computer()
    if nil ~= follow_computer then
        self.cs_player:SetDefaultFollow(follow_computer)
        
    end
end

---播放切换封层特效
---@public
function explore_player:play_change_layer_effect()
    
end

--endregion

return explore_player
