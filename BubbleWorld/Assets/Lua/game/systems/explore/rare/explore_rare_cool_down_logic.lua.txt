---
--- Generated by libin
--- File name : explore_rare_cool_down_logic.lua.txt
--- DataTime : 2023/04/03
--- Description : 
---

local timer_mgr = timer_manager
local tables = tables
local network = network
local message = message
---@type message_type
local message_type = enum.message_type

---@class explore_rare_cool_down_logic
local explore_rare_cool_down_logic = class("explore_rare_cool_down_logic")

--region base api

---构造方法
---@public
---@param row record_row
function explore_rare_cool_down_logic:ctor(row)
    ---@type string
    self.node_id = row:get_value(tables.Player.records.ExploreElite.columns.ActiveExploreNode)
    ---@type number
    self.target_time = row:get_value(tables.Player.records.ExploreElite.columns.DeadLineTs)
    self:init_cool_down()
    
    ---@type boolean
    self.is_send_message = false
end

---清理
---@public
function explore_rare_cool_down_logic:dispose()
    system_manager.explore:revert_rare_node(self.node_id)
    self.node_id = nil
    self.target_time = nil
    self.delta_time = nil
    if nil ~= self.timer_id then
        timer_mgr.remove_timer(self.timer_id)
        self.timer_id = nil
    end
end

--endregion

--region logic

---@private
function explore_rare_cool_down_logic:init_cool_down()
    local server_time = network.get_server_timestamp_of_second()
    self.delta_time = self.target_time - server_time
    
    self.timer_id = timer_mgr.add_timer_loop(1, function()
        self.delta_time = self.delta_time - 1
        message.broadcast(message_type.EXPLORE_RARE_COOL_DOWN_EACH, self.node_id, self.delta_time)
        if self.delta_time == 0 then
            system_manager.explore:del_rare_cool_down_logic(self.node_id)
            message.broadcast(message_type.EXPLORE_RARE_IS_HAS_RARE_MONSTER)
            message.broadcast(message_type.EXPLORE_RARE_COOL_DOWN_EACH, self.node_id, self.delta_time)
        end
    end)
end

---@public
---@param is_show boolean
function explore_rare_cool_down_logic:send_rare_cool_down_message(is_show)
    self.is_send_message = is_show
end

--endregion

return explore_rare_cool_down_logic
