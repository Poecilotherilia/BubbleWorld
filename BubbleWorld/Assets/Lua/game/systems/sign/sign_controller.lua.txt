---
--- Generated by bbhuang
--- File name : sign_controller.lua.txt
--- DateTime : 2022/09/13
--- Description :签到控制器[废弃]
---
local GameObject = cs.GameObject
local TweenUtil = cs.TweenUtil
local LuaUtil = cs.LuaUtil
local Ease = cs.Ease
local effect = effect
local data = data
local tables = tables
local message = message
local message_type = enum.message_type
local res = res
local material_texture_name = enum.common.material_texture_name
local array_table = array_table

local point_born = data.get(tables.Point.name, "Point_Sign_Effect_Born")
local point_bottom = data.get(tables.Point.name, "Point_Sign_Effect_Bottom")
local point_center = data.get(tables.Point.name, "Point_Sign_Effect_Center")
local trail_eff_count = 4

local tou_ming_icon_path = "Assets/Art/UI/Dynamic/Icon/Common/com_icon_touming.png"
---@class sign_controller
local sign_controller = class("sign_controller")

---构造函数
---@private
function sign_controller:ctor()
	---@type UnityEngine.GameObject
	self.eff_root = GameObject.Find("SignEffRoot")
	---乌云特效
	---@type number
	self.wu_yun_eff_id = nil
	
	---水晶特效
	---@type number
	self.crystal_eff_id = nil
	
	---发光特效
	---@type number
	self.crystal_light_eff_id = nil
	
	--水晶轨迹特效1
	---@type number
	self.crystal_trail_eff_id_1 = nil

	--水晶轨迹特效2
	---@type number
	self.crystal_trail_eff_id_2 = nil

	--水晶轨迹特效3
	---@type number
	self.crystal_trail_eff_id_3 = nil

	--水晶轨迹特效4
	---@type number
	self.crystal_trail_eff_id_4 = nil
	
	---水晶球特效加载完毕回调
	---@type function
	self.on_crystal_eff_load_finish_callback = function()
		self:on_crystal_eff_load_finish()
	end

	---卡牌移动加载完毕回调
	---@type function
	self.on_card_move_eff_load_finish_callback = function()
		self:card_move_eff_load_finish()
	end
	
	---@type DeusFramework.Res.Model.DfRes
	self.poker_text_res = nil
	
	---@type table<number, Dotween>
	self.tween_array = {}
	
	---@type number
	self.trail_eff_idx = nil
end

---初始化水晶特效
---@public
function sign_controller:init_crystal_eff()
	self.crystal_eff_id = effect.play_effect_async(
			"Ui_Effect_Scene_Sign_Shuijingqiu",
			self.eff_root,
			1,
			nil,
			self.on_crystal_eff_load_finish_callback
	)
	
	self.eff_root.transform:SetLocalPosition(
			point_born.PositionX / 10000,
			point_born.PositionY / 10000,
			point_born.PositionZ / 10000
	)

	self.eff_root.transform:SetLocalRotation(
			point_born.RotationX / 10000,
			point_born.RotationY / 10000,
			point_born.RotationZ / 10000
	)
end

---特效上升至屏幕底部
---@public
function sign_controller:eff_move_bottom()
	local tween = TweenUtil.DOLocalMove(self.eff_root,
			point_bottom.PositionX / 10000,
			point_bottom.PositionY / 10000,
			point_bottom.PositionZ / 10000,
			0.2,
			0,
			Ease.OutQuad,
			function()
				message.broadcast(message_type.SIGN_EFFECT_MOVE_TO_BOTTOM)
			end
	)
	array_table.insert(self.tween_array, tween)
end

---特效上升至屏幕中央
---@public
---@param is_tween boolean 是否需要动画
function sign_controller:eff_move_center(is_tween)
	if is_tween then
		local tween = TweenUtil.DOLocalMove(self.eff_root,
				point_center.PositionX / 10000,
				point_center.PositionY / 10000,
				point_center.PositionZ / 10000,
				1,
				0,
				Ease.OutQuad,
				function()
					message.broadcast(message_type.SIGN_EFFECT_MOVE_TO_CENTER)
				end
		)
		array_table.insert(self.tween_array, tween)
	else
		self.eff_root.transform:SetLocalPosition(
				point_center.PositionX / 10000,
				point_center.PositionY / 10000,
				point_center.PositionZ / 10000
		)
	end
end

---播放轨迹特效
---@public
function sign_controller:play_effect_trail()
	if self.trail_eff_idx == trail_eff_count then return end
	local idx = (self.trail_eff_idx or 0) + 1
	self.trail_eff_idx = idx
	local crystal_obj = effect.get_effect_by_unique_id(self.crystal_eff_id).game_object
	local parent_obj = crystal_obj.transform:Find("effect_scene_monv_shuijingqiu_ani/0"..idx)
	self["crystal_trail_eff_id_"..idx] = effect.play_effect_async(
			"Ui_Effect_Scene_Sign_Trails",
			parent_obj,
			1)
end

---水晶特效加载完毕
---@private
function sign_controller:on_crystal_eff_load_finish()
	self:set_poker_sprite(tou_ming_icon_path)
	message.broadcast(message_type.SIGN_EFFECT_LOAD_FINISH)
end

---水晶特效加速
function sign_controller:add_speed_crystal()
	local eff = effect.get_effect_by_unique_id(self.crystal_eff_id)
	if eff then
		eff:set_speed(5)

		local crystal_obj = eff.game_object.transform:Find("effect_scene_monv_shuijingqiu_ani").gameObject
		local tween = TweenUtil.DoScale(
				crystal_obj,
				0.2,
				1,
				0.2,
				Ease.OutQuad
		)
		array_table.insert(self.tween_array, tween)
	end
end

---播放乌云特效
---@public
function sign_controller:play_cloud_eff()
	self.wu_yun_eff_id = effect.play_effect_async(
			"Ui_Effect_Scene_Sign_Sjqmw",
			self.eff_root,
			1
	)
	
end

---播放发光特效
---@public
function sign_controller:play_light_eff()
	local eff = effect.get_effect_by_unique_id(self.crystal_light_eff_id)
	if eff then
		eff:set_active(true)
		return
	end
	self.crystal_light_eff_id = effect.play_effect_async(
			"Ui_Effect_Scene_Sign_Sjqfg",
			self.eff_root,
			1
	)
end

---隐藏发光特效
---@public
function sign_controller:hide_light_eff()
	local eff = effect.get_effect_by_unique_id(self.crystal_light_eff_id)
	if eff then
		eff:set_active(false)
	end
end

---销毁轨迹特效
---@public
function sign_controller:destroy_trail_eff()
	if self.crystal_trail_eff_id_1 then
		effect.manual_unload_effect(self.crystal_trail_eff_id_1)
		self.crystal_trail_eff_id_1 = nil
	end

	if self.crystal_trail_eff_id_2 then
		effect.manual_unload_effect(self.crystal_trail_eff_id_2)
		self.crystal_trail_eff_id_2 = nil
	end

	if self.crystal_trail_eff_id_3 then
		effect.manual_unload_effect(self.crystal_trail_eff_id_3)
		self.crystal_trail_eff_id_3 = nil	
	end

	if self.crystal_trail_eff_id_4 then
		effect.manual_unload_effect(self.crystal_trail_eff_id_4)
		self.crystal_trail_eff_id_4 = nil
	end
	self.trail_eff_idx = nil
end

---销毁
---@public
function sign_controller:dispose()
	for i, v in ipairs(self.tween_array) do
		TweenUtil.Clear(v)
	end
	self.tween_array = nil
	
	self.eff_root = nil
	self:destroy_trail_eff()
	effect.manual_unload_effect(self.wu_yun_eff_id)
	self.wu_yun_eff_id = nil
	effect.manual_unload_effect(self.crystal_eff_id)
	self.crystal_eff_id = nil
	effect.manual_unload_effect(self.crystal_light_eff_id)
	self.crystal_light_eff_id = nil

	if self.poker_text_res then
		res.unload_asset(self.poker_text_res)
		self.poker_text_res = nil
	end
end

---设置牌阵icon
---@public
---@param path string 资源路径
function sign_controller:set_poker_sprite(path)
	local eff = effect.get_effect_by_unique_id(self.crystal_eff_id)
	if not eff then
		log.error("no crystal eff sign")
		return
	end

	local crystal_obj = eff.game_object.transform:Find("ui_effect_scene_sign_shuijingqiu").gameObject

	if not crystal_obj then
		log.error("no crystal quad eff sign")
		return
	end
	
	crystal_obj:SetActive(path ~= tou_ming_icon_path)
	res.load_asset_async(
			path,
			df.enum.asset_type.texture, nil,
			nil,
			nil,
			function(spriteRes)
				if self.poker_text_res then
					res.unload_asset(self.poker_text_res)
					self.poker_text_res = nil
				end
				self.poker_text_res = spriteRes
				
				LuaUtil.SetMatTexture(crystal_obj, material_texture_name.MAIN_TEXTURE, spriteRes.Result, 1)
			end
	)
end



return sign_controller 