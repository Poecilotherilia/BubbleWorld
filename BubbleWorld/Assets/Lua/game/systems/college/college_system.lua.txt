---
--- Generated by wuhaijun
--- File name : college_system.lua.txt
--- DateTime : 2022/06/20
--- Description : 学院系统
---

local college_controller = require 'game/windows/college/exam/college_controller'
local data = data
local tables = tables
local college_data = game_data_manager.college
local study_state_bit_flag = college_data.study_state_bit_flag
local enum = enum
local enum_proto = enum.proto
local game_scene_manager = game_scene_manager
---@type enum_college
local enum_college = enum.college
local college_state_flag = enum_college.college_state_flag
local scene = scene
local story_system = system_manager.story
local string_is_nil_or_empty = string.is_nil_or_empty
local string_split = string.split
local table_concat = table.concat
---@class college_system
local college_system = class("college_system")

---构造函数
---@protected
function college_system:ctor()
    self:init()
end

---初始化
---@private
function college_system:init()
    data.load(tables.Subject.name)
    self.next_answer_time = 2
end

---销毁
---@public
function college_system:dispose()
    data.unload(tables.Subject.name)
    if self.college_controller then
        self.college_controller:dispose()
        self.college_controller = nil
    end
end

--region public functions

---预加载场景所需角色资源
---@public
function college_system:preload_role_res_sync()
    local role_res, role_action
    local role_res_action = data.get(tables.ConstClient.name, tables.ConstClient.ids.KW_DH_QIMOKAOSHI).String
    local res = string_split(role_res_action, ',')
    role_res = res[1]
    role_action = res[2]
    self.college_controller = college_controller.new()
    return self.college_controller:preload_sync(role_res, role_action)
end

---控制播放待机动作
---@public
function college_system:play_idle_action()
    if self.college_controller then
        self.college_controller:play_idle_action()
    end
end

---控制播放发题动作
---@public
function college_system:play_send_papers_action(callback)
    if self.college_controller then
        self.college_controller:play_send_papers_action()
        timer_manager.add_timer(self.next_answer_time, callback)
    end
end

---清理角色控制器
---@public
function college_system:unload_college_controller()
    if self.college_controller then
        self.college_controller:dispose()
        self.college_controller = nil
    end
end

---处理考试选项为table
---@public
---@param num number
function college_system:handle_exam_options(num)
    if num == nil then
        return
    end
    local t = {}
    for i = 3, 0, -1 do
        t[#t + 1] = math.floor(num / 2 ^ i)
        num = num % 2 ^ i
    end
    return t
end

---获取当前学院场景id
---@public
---@return string scene_id
function college_system:get_cur_scene_id()
    local college_state = college_data.college_state
    local study_state = college_data.study_state
    ---进入学院
    local scene_id
    if college_state == college_state_flag.SUSPENSION then
        --休学
        scene_id = data.get(tables.ConstClient.name, tables.ConstClient.ids.SCHOOL_GATE_SCENE_ID).String
    else
        ---@type number 开学剧情是否播放
        local semester_module_finish = college_data:get_property_number(tables.Player.properties.SemesterModuleFinish)
        if semester_module_finish == 0 then
            data.load(tables.Semester.name)
            local semester_id = college_data:get_property_data(tables.Player.properties.SemesterId)
            if semester_id then
                data.load(tables.ModuleSide.name)
                local module_ids = data.get(tables.Semester.name, semester_id).StartStoryId
                story_system:start_func_story(module_ids, nil, true, function()
                    self:swap_college_scene(true)
                end)
                data.unload(tables.ModuleSide.name)
                local ids = table_concat(module_ids, ',')
                college_data:play_college_story(enum_proto.DramaType.ECD_SEMESTER_START, ids)
            end
            data.unload(tables.Semester.name)
        else
            if college_state == college_state_flag.WEEKEND or college_data.study_state_bit_flag.class_cd(study_state) then
                -- 周末休息、上课cd
                scene_id = data.get(tables.ConstClient.name, tables.ConstClient.ids.SCHOOL_GATE_SCENE_ID).String
            elseif college_data.study_state_bit_flag.final_examing(study_state) then
                --期末考试
                scene_id = data.get(tables.ConstClient.name, tables.ConstClient.ids.EXAMINATION_OUTSIDE_SCENE_ID).String
            else
                local lesson_id = college_data:get_property_data(tables.Player.properties.LessonId)
                if not string_is_nil_or_empty(lesson_id) then
                    local subject_id = data.get(tables.Lesson.name, lesson_id).SubjectId
                    scene_id = data.get(tables.Subject.name, subject_id).Scene
                end
            end
        end
    end
    return scene_id
end

---跳转学院场景
---@public
function college_system:swap_college_scene(is_keep_window)
    local scene_id = self:get_cur_scene_id()
    if string_is_nil_or_empty(scene_id) or scene_id == scene.current().id then
        return
    end
    
    game_scene_manager.switch_scene(scene_id, is_keep_window and 1 or 0)
end

--endregion

return college_system