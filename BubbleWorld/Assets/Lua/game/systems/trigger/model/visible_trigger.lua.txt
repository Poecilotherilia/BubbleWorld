---
--- Generated by lvyuqiang
--- File name : visible_trigger.lua.txt
--- DateTime : 2022/07/14
--- Description : 可见触发器
---

local super = require "game/systems/trigger/model/base_trigger"
---@class visible_trigger
local visible_trigger = class("visible_trigger", super)
local entry_asset = "Assets/Art/UI/Prefab/Trigger/trigger_entry.prefab"
local asset_type = require 'framework/res/model/asset_type'
local hero_manager = require 'game/hero/hero_manager'
local btn_multi_click_mgr = button_multi_click_manager
local res = res
local cs = cs
local t = tables
local data = data
local table = table
local log = log
local tables = tables
local string = string

local message_type = enum.message_type
local message = message
local guide_trigger_type = enum.guide.guide_trigger_type

---构造函数
---@private
function visible_trigger:ctor(id, config_id, table_name)
    super.ctor(self, id, config_id, table_name)
end

function visible_trigger:init()
    super.init(self)
    ---@type TriggerRes
    self.trigger_res_data = data.get(t.TriggerRes.name, self.trigger_data.ResId)
    self.priority = self.trigger_res_data.Priority
    if self.trigger_res_data.Type == 1 then
        self.target_go = cs.GameObject.Find(self.trigger_res_data.Value)
        if self.target_go == nil then
            log.error("visible_trigger target is nil: ", self.trigger_res_data.Value)
        end
    elseif self.trigger_res_data.Type == 2 then
        local p = data.get(t.Point.name, self.trigger_res_data.Value)
        self.target_pos = cs.Vector3(p.PositionX / 10000, p.PositionY / 10000, p.PositionZ / 10000)
    end

    if not string.is_nil_or_empty(self.trigger_res_data.PathFindingOffsetPoint) then
        self.path_finding_offset = data.get(t.Point.name, self.trigger_res_data.PathFindingOffsetPoint)
    end

    self.bubble_icon = self.trigger_res_data.BubbleIcon
    self.entry_texture = res.load_asset(self.trigger_res_data.EntryIcon, asset_type.texture)

    local parent = self.target_go and self.target_go.transform or nil
    ---@type UnityEngine.GameObject
    self.entry_go = res.load_instance(entry_asset, self.id, parent)

    if self.trigger_res_data.Type == 1 then
        if not string.is_nil_or_empty(self.trigger_res_data.OffsetPoint) then
            ---@type Point
            local point = data.get(tables.Point.name, self.trigger_res_data.OffsetPoint)
            self.entry_go:SetLocalPosition(point.PositionX / 10000, point.PositionY / 10000, point.PositionZ / 10000)
            self.entry_go:SetLocalRotation(point.RotationX / 10000, point.RotationY / 10000, point.RotationZ / 10000)
        end
    else
        if self.target_pos then
            self.entry_go.transform.position = self.target_pos
        end
    end

    local render = self.entry_go:GetComponentInChildren(typeof(cs.Renderer))
    render.material.mainTexture = self.entry_texture.Result

    self.tap_gesture_callback_func = function(id, go)
        self:tap_gesture_callback(id, go)
    end

    ---@type Game.Behaviour.Trigger.TriggerEntryItem
    self.entry = self.entry_go:GetComponentInChildren(typeof(cs.TriggerEntry))
    self.entry:SetTapCallback(self.tap_gesture_callback_func)
    self.entry.triggerId = self.id

    ---红点
    if not table.is_table_nil_or_empty(self.trigger_res_data.RedPoint) then
        ---@type DeusFramework.RedPoint.DfRedPoint
        local red_point = self.entry_go:GetComponent(typeof(CS.DeusFramework.RedPoint.DfRedPoint))
        if red_point then
            local id = self.trigger_res_data.RedPoint[1]
            ---@type Point
            local p = data.get(t.Point.name, self.trigger_res_data.RedPoint[2])
            red_point.Id = id
            red_point.redPointGameObject.transform:SetLocalPosition(p.PositionX / 10000, p.PositionY / 10000, p.PositionZ / 10000)
        end
    end

    self.path_finding_callback_func = function()
        self:path_finding_callback()
    end

    ---待领取免费体力
    ---@type number
    self.free_power = nil
    self:create_simple_property("free_power", 0, true)

    ---待领取免费体力是否可见
    ---@type boolean
    self.is_free_power_visible = nil
    self:create_simple_property("is_free_power_visible", false, true)
end

---设置入口可见性
---@param visible boolean
function visible_trigger:set_entry_visible(visible)
    if self.entry then
        self.entry.Visible = visible
    end
end

---设置触发器可见性
---@param visible boolean
function visible_trigger:set_trigger_visible(visible)
    self:set_entry_visible(visible)
    if self.target_go then
        self.target_go:SetActive(visible)
    end
end

---点击入口图标回调
function visible_trigger:tap_gesture_callback(id, go)
    ---防止多点触摸
    if btn_multi_click_mgr.check_can_click() then
        btn_multi_click_mgr.do_click()
        self:on_tap_bubble()

        message.broadcast(message_type.GUIDE_TRY_TRIGGER, guide_trigger_type.trigger_on, id)
    end
end

---寻路结束回调
function visible_trigger:path_finding_callback()
    hero_manager.stop_path_finding()
    self:execute()
end

---点击气泡
function visible_trigger:on_tap_bubble()
    self:start_path_finding()
end

---开始寻路
---@public
function visible_trigger:start_path_finding()
    local x
    local y
    local z
    if self.trigger_res_data.Type == 1 then
        x = self.target_go.transform.position.x
        y = self.target_go.transform.position.y
        z = self.target_go.transform.position.z
    elseif self.trigger_res_data.Type == 2 then
        x = self.target_pos.x
        y = self.target_pos.y
        z = self.target_pos.z
    end
    if self.path_finding_offset then
        x = x + self.path_finding_offset.PositionX / 10000
        y = y + self.path_finding_offset.PositionY / 10000
        z = z + self.path_finding_offset.PositionZ / 10000
    end
    hero_manager.start_path_finding(x, y, z, self.path_finding_callback_func)
end

---dispose
---@public
function visible_trigger:dispose()
    super.dispose(self)
    res.unload_asset(self.entry_texture)
    res.unload_instance(self.entry_go)
    self.path_finding_offset = nil
    self.target_go = nil
    self.target_pos = nil
    self.entry_texture = nil
    self.entry_go = nil
    self.entry = nil
end

return visible_trigger