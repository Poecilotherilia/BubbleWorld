---
--- Generated by lvyuqiang
--- File name : base_trigger.lua.txt
--- DateTime : 2022/05/12
--- Description : 触发器基类
---

local t = tables
local window = window
local super = observable
local string = string
local log = log
local story_system = system_manager.story
local game_scene_mgr
local explore_system = system_manager.explore

---@class base_trigger
local base_trigger = class("base_trigger", super)

---构造函数
---@private
function base_trigger:ctor(id, config_id, table_name)
    super.ctor(self)
    self.id = id
    self.config_id = config_id
    self.table_name = table_name or t.Trigger.name
    ---执行触发器时所使用的参数
    self.param = nil
    self:init()
end

---init
---@private
function base_trigger:init()
    game_scene_mgr = game_scene_manager

    self.trigger_data = data.get(self.table_name, self.config_id)
end

---dispose
---@public
function base_trigger:dispose()

end

---执行触发器
---@public
---@param callback function 回调
function base_trigger:execute(callback)
    log.info("start trigger: ", self.id)
    local func_type = self.trigger_data.FunctionType
    local func_value = self.trigger_data.FunctionValue
    self.on_complete_func = function()
        self:on_complete(callback)
    end

    if func_type == 1 then
        ---加载场景
        game_scene_mgr.switch_scene(func_value)
        self:on_complete(callback)
    elseif func_type == 4 then
        explore_system:try_dungeon_battle(func_value)
    elseif func_type == 2 then
        ---打开窗体
        local window_values = string.split(func_value, ',')
        if #window_values == 1 then
            window.open(func_value, self.param)
        else
            local w_id = window_values[1]
            local p_id = window_values[2]
            local node = window_values[3]
            local p_window = window.get_window(p_id)
            if p_window then
                p_window:open_sub_window(w_id, self.param, node)
            else
                log.error("window doesn't exist: ", p_id, " , trigger id: ", self.id)
            end
        end
        self:on_complete(callback)
    elseif func_type == 3 then
        ---表演剧情
        local module_ids = string.split(func_value, ',')
        story_system:start_func_story(module_ids, nil, false, self.on_complete_func)
    elseif func_type == 0 then
        if self.id == "Trigger_Free_Power" then
            ---领取免费体力
            local msg = {
                player_id = game_data_manager.player.player_uid,
            }
            network.send_message_async(enum.proto.EGameMsgID.REQ_GET_FREE_POWER, message_names.ReqGetFreePower, msg)
        end
    end
    self.param = nil
end

function base_trigger:on_complete(callback)
    log.info("end trigger: ", self.id)
    if callback then
        callback()
    end
end

return base_trigger