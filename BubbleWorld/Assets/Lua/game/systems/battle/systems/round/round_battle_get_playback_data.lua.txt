---
--- Generated by wuhaijun
--- File name : round_battle_get_playback_data.lua.txt
--- DateTime : 2023/01/17
--- Description : 获取战斗回放数据
---

---@type battle_helper
local helper = battle_helper
local math_floor = math.floor

---@type battle_components
local battle_components = require(helper.path.battle_components)

---@class round_battle_get_playback_data
local round_battle_get_playback_data = class("round_battle_get_playback_data")

---构造函数
---@protected
---@param context context
function round_battle_get_playback_data:ctor(context)
    self.context = context

    ---请求回放数据回调
    ---@private
    ---@type fun(idx:number)
    self.request_replay_data_callback = function(idx) self:on_request_replay_data(idx) end
end

---初始化
---@private
function round_battle_get_playback_data:initialize()
    -- 监听回放索引组件
    local battlefield, _ = self.context:get_unique_component(battle_components.battle_field)
    battlefield:add_listener(battle_components.replay_idx, self.on_replay_idx_changed, self)
    
    -- 初始时获取一次，-999为特殊标识
    self.context.controller:add_timer(2000, self.request_replay_data_callback, -999)
end

---回放索引改变
---@private
---@param _ entity
---@param replay_idx number
function round_battle_get_playback_data:on_replay_idx_changed(_, replay_idx)
    if replay_idx < 0 then return end
    
    local count = self.context.database:get_battle_data_count()
    local interval = math_floor(count * 0.5)
    if interval > 10 then interval = 10 end
    self.context.controller:add_timer(interval * 1000, self.request_replay_data_callback, replay_idx)
end

---回放索引改变
---@private
---@param index number
function round_battle_get_playback_data:on_request_replay_data(index)
    if index == -999 then
        index = nil
    end
    self.context.network:request_battle_replay(nil, index)
end

---卸载
---@public
function round_battle_get_playback_data:tear_down()
    -- 战场实体
    local battlefield, _ = self.context:get_unique_component(battle_components.battle_field)
    battlefield:remove_listener(battle_components.replay_idx, self.on_replay_idx_changed, self)

    self.request_replay_data_callback = nil
    
    self.context = nil
end

return round_battle_get_playback_data