---
--- Generated by wuhaijun
--- File name : system_battle_render_map.lua.txt
--- DateTime : 2023/10/10
--- Description :
---

---@type battle_helper
local helper = battle_helper
local TweenUtil = cs.TweenUtil
local Shader = cs.Shader
local Ease_Value = cs.Ease.OutCubic
local UpdateTypeManual = cs.UpdateType.Manual

---@type battle_components
local battle_components = require(helper.path.battle_components)
---@type matchers
local matchers = require(helper.path.ecs .. 'matchers')

---@type reactive_system
local super = require(helper.path.ecs .. 'reactive_system')

---@class system_battle_render_map : reactive_system
local system_battle_render_map = class("system_battle_render_map", super)

local SHADER_PROPERTY_NAME<const> = Shader.PropertyToID("_LightMapPower")

---构造函数
---@protected
---@param context context
function system_battle_render_map:ctor(context)
    super.ctor(self, context)

    ---Tween动画
    ---@private
    ---@type fun()
    self.tween_finished_callback = function() self:clear_tween() end

    ---Tween动画
    ---@private
    ---@type DG.Tweening.Tween
    self.num_tween = nil
end

---获取触发配置
---@protected
---@param context context
---@return collector
function system_battle_render_map:get_trigger(context)
    return context:get_collector(matchers.all(battle_components.battle_map))
end

---过滤
---@protected
---@param entity entity
---@return boolean
function system_battle_render_map:filter(entity)
    return entity:has_component(battle_components.battle_map)
end

---组件变化时执行
---@protected
---@param list entity[] 实体列表
---@param count number 列表长度
function system_battle_render_map:executes(list, count)
    for i = 1, count do
        self:on_entity_handle(list[i])
    end
end

---更新属性值
---@private
local set_property_update = function(change_value)
    Shader.SetGlobalFloat(SHADER_PROPERTY_NAME, change_value)
end

---实体处理
---@private
---@param entity entity
function system_battle_render_map:on_entity_handle(entity)
    ---@type battle_map_component_data
    local comp_data = entity:get_component(battle_components.battle_map)
    local begin_value = comp_data.begin_value or 0
    local end_value = comp_data.end_value or 1
    local duration = comp_data.duration or 0.2

    self:clear_tween()
    self.num_tween = TweenUtil.DoChangeFloat(begin_value, end_value, duration, 0, set_property_update, 
            self.tween_finished_callback, Ease_Value, UpdateTypeManual, true)
end

---清理Tween
---@private
function system_battle_render_map:clear_tween()
    if self.num_tween ~= nil then
        TweenUtil.Clear(self.num_tween)
        self.num_tween = nil
    end
end

---卸载
---@protected
function system_battle_render_map:tear_down()
    self:clear_tween()
    self.tween_finished_callback = nil
    super.tear_down(self)

end

return system_battle_render_map
