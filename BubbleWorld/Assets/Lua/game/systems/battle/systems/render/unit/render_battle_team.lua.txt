---
--- Generated by wuhaijun
--- File name : render_battle_team.lua.txt
--- DateTime : 2022/05/07
--- Description : 战斗队伍渲染层
---

local helper = battle_helper
local enum_battle = enum.battle
local battle_renderer_type = enum_battle.battle_renderer_type
local team_type_flag = enum_battle.team_type_flag
local role_attach_point_type = enum.common.role_attach_point_type
local GameObject = cs.GameObject
local LuaUtil = cs.LuaUtil

---@type battle_components
local battle_components = require(helper.path.battle_components)

---@type base_render
local super = require(helper.path.battle_render_unit .. 'base_render')

---@class render_battle_team : base_render
local render_battle_team = class("render_battle_team", super)

---构造函数
---@protected
function render_battle_team:ctor()
    super.ctor(self, battle_renderer_type.TEAM)

    ---队伍
    ---@private
    ---@type UnityEngine.GameObject
    self.team_object = nil
    ---@private
    ---@type UnityEngine.Transform
    self.team_transform = nil
end

---加载单位预制体
---@protected
function render_battle_team:load_unit_handle()
    local entity = self:get_entity()
    ---@type battle_unit_info
    local unit_info = entity:get_component(battle_components.unit_info).value

    -- 获取名字
    local team_name
    local bullet_attack_name
    if unit_info.team_type == team_type_flag.OWN then
        team_name = 'own'
        bullet_attack_name = role_attach_point_type.OUR_TEAM_BULLET_ATTACK_POINT
    elseif unit_info.team_type == team_type_flag.ENEMY then
        team_name = 'enemy'
        bullet_attack_name = role_attach_point_type.ENEMY_TEAM_BULLET_ATTACK_POINT
    else
        helper.error("team error, team = ", helper.get_enum_name(team_type_flag, unit_info.team_type))
    end
    
    -- 创建队伍Object
    local object = GameObject('team_' .. team_name)
    local trans = object.transform
    self.team_transform = trans
    self.team_object = object
    object:SetParent(self.renderer:get_root_transform())

    -- 设置队伍位置
    ---@type MapPoint 
    local team_point = unit_info.index_point_info.StandingPoint
    trans:SetPosition(team_point.Position.X, team_point.Position.Y, team_point.Position.Z)
    trans:SetRotation(team_point.Rotation.X, team_point.Rotation.Y, team_point.Rotation.Z)
    trans:SetLocalScale(team_point.Scale.X, team_point.Scale.Y, team_point.Scale.Z)

    -- 创建子弹群攻挂点
    local bullet_attack_object = GameObject(bullet_attack_name)
    local bullet_attack_trans = bullet_attack_object.transform
    bullet_attack_trans:SetParent(trans)

    self.is_init = true

    -- 初始完毕回调
    if self.init_finished_callback ~= nil then
        self.init_finished_callback(self)
    end
end

---获取挂点
---@public
---@param point_name string 挂点名字
---@return UnityEngine.Transform
function render_battle_team:get_attach_point(point_name)
    local trans = self.team_transform:Find(point_name)
    if not LuaUtil.IsNull(trans) then
        return trans
    else
        return self.team_transform
    end
end

---获取欧拉角
---@public
---@return number, number, number
function render_battle_team:get_euler_angles()
    return self.team_transform:GetEulerAngles()
end

---清理
---@public
function render_battle_team:clear()
    if self.team_object ~= nil then
        GameObject.Destroy(self.team_object)
        self.team_object = nil
        self.team_transform = nil
    end
    
    super.clear(self)
end

return render_battle_team