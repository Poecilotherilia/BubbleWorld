---
--- Generated by wuhaijun
--- File name : system_battle_render_action.lua.txt
--- DateTime : 2021/11/08
--- Description : 
---

---@type battle_helper
local helper = battle_helper
local data_mgr = data
local table_names = tables
local is_nil_or_empty = string.is_nil_or_empty

---@type battle_utility
local battle_utility = require(helper.path.battle_utils .. 'battle_utility')
---@type battle_components
local battle_components = require(helper.path.battle_components)
---@type matchers
local matchers = require(helper.path.ecs .. 'matchers')
---@type reactive_system
local super = require(helper.path.ecs .. 'reactive_system')

---@class system_battle_render_action : reactive_system
local system_battle_render_action = class("system_battle_render_action", super)

---构造函数
---@protected
---@param context context
function system_battle_render_action:ctor(context)
    super.ctor(self, context)
end

---获取触发配置
---@protected
---@param context context
---@return collector
function system_battle_render_action:get_trigger(context)
    return context:get_collector(matchers.all(battle_components.unit_action))
end

---过滤
---@protected
---@param entity entity
---@return boolean
function system_battle_render_action:filter(entity)
    return entity:has_component(battle_components.unit_action)
end

---组件变化时执行
---@protected
---@param entity_list entity[]
---@param count number
function system_battle_render_action:executes(entity_list, count)
    for i = 1, count do
        self:on_unit_show_action_handle(entity_list[i])
    end
end

---单位显示动作
---@private
---@param entity entity 动作名称
function system_battle_render_action:on_unit_show_action_handle(entity)
    ---@type battle_unit_info 单位数据
    local unit_info = entity:get_component(battle_components.unit_info).value

    ---@type RoleRes
    local role_res_data = data_mgr.get(table_names.RoleRes.name, unit_info.role_res_mid)
    if role_res_data == nil then
        helper.error("没找到RoleRes数据, RoleResId = ", unit_info.role_res_mid, ", uid = ", helper.to_string(unit_info.uid))
        return
    end

    ---@type unit_action_component_data 播放动画
    local comp = entity:get_component(battle_components.unit_action)

    ---@type string 动作表id
    local action_mid = role_res_data[comp.name]
    if is_nil_or_empty(action_mid) then
        helper.error('没有找到ActionId在RoleRes表中, 字段名 = ', comp.name, ", RoleResId = ", unit_info.role_res_mid)
        return
    end

    -- 播放动作处理
    battle_utility.unit_play_action(self.context, entity, action_mid, comp.callback, comp.is_loop, comp.fade_time)
end

return system_battle_render_action