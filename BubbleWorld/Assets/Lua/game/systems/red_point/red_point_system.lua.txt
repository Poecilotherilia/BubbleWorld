---
--- Generated by lvyuqiang
--- File name : red_point_system.lua.txt
--- DateTime : 2023/07/28
--- Description : 红点系统
---

---@class red_point_system
local red_point_system = class("red_point_system")
local red_point_class = require "game/systems/red_point/model/red_point"
local string_is_nil_or_empty = string.is_nil_or_empty
local net_rp_type = enum.proto.ERedpointType
local message = message
local message_type = enum.message_type
local log = log
local data = data
local t = tables
local t_red_point_ids = t.RedPoint.ids
local game_util = require "game/utils/game_util"
local net_rps = {
    [net_rp_type.RPT_APPOINT_STATE] = t_red_point_ids.RedPoint_Dispatch_Back_Chest, ---（派遣）累积奖励时间已达上限(当前可领取委派奖励)
    [net_rp_type.RPT_UNLOCK_APPOINT_AREA] = t_red_point_ids.RedPoint_Dispatch_Area_Page, ---（派遣）未耗尽地区解锁机会(当前可以解锁委派区域)
    [net_rp_type.RPT_7_DAY_REWARD] = t_red_point_ids.RedPoint_Active_AccumulatedSignIn_Enter, ---7日登录奖励可领取
    [net_rp_type.RPT_ACTIVE_MISSION_REWARD] = t_red_point_ids.RedPoint_Task_Liveness_Enter, ---有活跃任务奖励可领取(包含活跃度奖励) 
    --[net_rp_type.RPT_TALENT_MISSION_REWARD] = t_red_point_ids.RedPoint_Task_Tanlent_Enter, ---当前正在进行的天赋之路任务奖励可领取
    [net_rp_type.RPT_FREE_POWER_REWARD] = t_red_point_ids.RedPoint_Adventure_Free_Power_Jump, ---当前有可领取的免费体力
    [net_rp_type.RPT_BEGINNING_MISSION_REWARD_DAY01] = t_red_point_ids.RedPoint_Task_Liveness_Entry_1, ---第一天新手任务奖励可领取
    [net_rp_type.RPT_BEGINNING_MISSION_REWARD_DAY02] = t_red_point_ids.RedPoint_Task_Liveness_Entry_2, ---第二天新手任务奖励可领取
    [net_rp_type.RPT_BEGINNING_MISSION_REWARD_DAY03] = t_red_point_ids.RedPoint_Task_Liveness_Entry_3, ---第三天新手任务奖励可领取
    [net_rp_type.RPT_BEGINNING_MISSION_REWARD_DAY04] = t_red_point_ids.RedPoint_Task_Liveness_Entry_4, ---第四天新手任务奖励可领取
    [net_rp_type.RPT_BEGINNING_MISSION_REWARD_DAY05] = t_red_point_ids.RedPoint_Task_Liveness_Entry_5, ---第五天新手任务奖励可领取
    [net_rp_type.RPT_BEGINNING_MISSION_REWARD_DAY06] = t_red_point_ids.RedPoint_Task_Liveness_Entry_6, ---第六天新手任务奖励可领取
    [net_rp_type.RPT_BEGINNING_MISSION_REWARD_DAY07] = t_red_point_ids.RedPoint_Task_Liveness_Entry_7, ---第七天新手任务奖励可领取
    [net_rp_type.RPT_PVP_BATTLE_REPORT] = t_red_point_ids.RedPoint_Pvp_Report, ---玩家生成新的防守失败的战报
    [net_rp_type.RPT_BP_CAN_REWARDS] = t_red_point_ids.RedPoint_Active_BusinessPass_Reward, ---战令奖励页签
    [net_rp_type.RPT_BP_DAILY_TASK] = t_red_point_ids.RedPoint_Active_BusinessPass_DailyMission, ---战令日常任务页签
    [net_rp_type.RPT_BP_WEEKLY_TASK] = t_red_point_ids.RedPoint_Active_BusinessPass_WeeklyMission,   ---战令周常任务
    [net_rp_type.RPT_BP_SPECAIL_TASK] = t_red_point_ids.RedPoint_Active_BusinessPass_TerminallyMission,   ---战令期任务
    [net_rp_type.RPT_MONTH_CARD_REWARDS] = t_red_point_ids.RedPoint_Active_MonthCard_Enter, ---月卡奖励可领取
    [net_rp_type.RPT_COMMUNITY_LOG] = t.RedPoint.ids.RedPoint_Guild_Log, --- 战团日志红点
    [net_rp_type.RPT_COMMUNITY_MISSION_PROGRESS_REWARD] = t.RedPoint.ids.RedPoint_Task_GuildTask_Progress_Reward, --- 有公社任务阶段奖励可领取 
    [net_rp_type.RPT_COMMUNITY_MISSION_REWARD] = t.RedPoint.ids.RedPoint_Task_GuildTask_Reward, --- 有公社任务奖励可领取 
    [net_rp_type.RPT_COMMUNITY_MISSION_UPDATE] = t.RedPoint.ids.RedPoint_Task_GuildTask_Refresh, --- 公社任务列表刷新
    [net_rp_type.RPT_TALENT_MISSION_INSIDE_1] = t.RedPoint.ids.RedPoint_Tanlent_Toggle_First, --- 天赋之路1切换红点
    [net_rp_type.RPT_TALENT_MISSION_INSIDE_2] = t.RedPoint.ids.RedPoint_Tanlent_Toggle_Second, --- 天赋之路2切换红点
    [net_rp_type.RPT_COMMUNITY_TRAINNING_UNLOCK] = t.RedPoint.ids.RedPoint_Group_PVE_Unlock, --- 公社训练功能解锁 
    [net_rp_type.RPT_COMMUNITY_TRAINNING_REFRESH] = t.RedPoint.ids.RedPoint_Group_PVE_Refresh, --- 公社训练每周刷新 
    [net_rp_type.RPT_COMMUNITY_TRAINNING_NEW_LEVEL] = t.RedPoint.ids.RedPoint_Group_PVE_Boss_Unlock, --- 公社训练新解锁难度
    [net_rp_type.RPT_DAILY_PACKAGE_REWARDS] = t.RedPoint.ids.RedPoint_DailyPay_Enter,    ---每日特惠入口
    [net_rp_type.RPT_LIMIT_TIME_EXCHANGE] = t.RedPoint.ids.RedPoint_TimeLimitedActive_Reward,     ---显示活动可兑换
    [net_rp_type.RPT_LIMIT_TIME_REWARDS] = t.RedPoint.ids.RedPoint_TimeLimitedActive_Pay,          ---显示活动付费可领奖
    [net_rp_type.RPT_DISPATCH_MISSION_REWARD] = t.RedPoint.ids.RedPoint_Task_Dispatch_Enter, --- 公社训练新解锁难度
}

---构造函数
---@private
function red_point_system:ctor()
    ---@type table<string,red_point>
    self.red_points = {}
end

function red_point_system:start(uid)
    message.add_listener(message_type.SET_RED_POINT, self.set_red_point, self)
    ---@type Player
    local player = network.get_object(uid)
    player:add_property_listener(t.Player.properties.RedpointFlag, self.on_red_point_flag_changed, self)
    local rp_data_list = data.get_all(t.RedPoint.name)
    for k, v in pairs(rp_data_list) do
        ---@type RedPoint
        local rp_data = v
        local rp = red_point_class.new()
        rp.id = rp_data.Id
        self.red_points[k] = rp
    end

    for k, v in pairs(rp_data_list) do
        local parent_id = v.ParentId
        if not string_is_nil_or_empty(parent_id) then
            local parent = self.red_points[parent_id]
            local rp = self.red_points[k]
            if parent then
                rp.parent = parent
                parent:add_child(rp)
            else
                log.error("red_point parent error: ", parent_id)
            end
        end
    end

    local flag = player:get_property_number(t.Player.properties.RedpointFlag)
    self:set_red_point_flag(flag)
end

---@private
function red_point_system:on_red_point_flag_changed(_, _, _, flag)
    self:set_red_point_flag(flag)
end

---@private
function red_point_system:set_red_point_flag(flag)
    for k, v in pairs(net_rps) do
        local visible = game_util.is_bit_flag(flag, k)
        self:set_red_point(v, visible)
    end
end

---@private
function red_point_system:set_red_point(id, visible)
    local rp = self.red_points[id]
    if rp then
        rp:set_visible(visible)
    else
        log.error("set_red_point error, id doesn't exist: ", id)
    end
end

---获取红点状态
---@public
---@param id string 红点配置id
---@return boolean true表示显示红点中
function red_point_system:get_red_point_state(id)
    local rp = self.red_points[id]
    if rp ~= nil then
        return rp.visible
    end

    return false
end

return red_point_system